# Technical Specification: Deeper E-Signature Integration (DocuSign)

**Document ID:** LXP-TS-015
**Version:** 1.0
**Author:** Gemini Code Assist, Lead Engineer
**Status:** Draft

## 1. Overview

This document outlines the technical design for a deep integration with the DocuSign eSignature API. The goal is to evolve beyond our current basic "send link" functionality into a fully embedded, seamless e-signature experience within the LexiContract AI platform. This will provide users with advanced capabilities like multi-signer routing, real-time status tracking, and an embedded signing ceremony, significantly improving workflow efficiency and user experience.

## 2. Goals

*   Provide a seamless, in-app experience for configuring and sending documents for signature.
*   Support complex workflows, including multiple signers and a defined signing order.
*   Display real-time signature status directly on the contract page (e.g., "Sent," "Viewed," "Signed").
*   Allow users to sign documents directly within the LexiContract AI application without being redirected externally (Embedded Signing).
*   Securely manage DocuSign API credentials and tokens on a per-organization basis.

## 3. Backend Architecture

### 3.1. Authentication

We will use the DocuSign OAuth 2.0 JWT Grant flow for service-level authentication. This is ideal for backend processes where a user is not present. The organization's administrator will connect their DocuSign account once, providing consent for our application to act on their behalf. The resulting access token will be stored securely and used for all API calls. This will be managed within our existing integration framework.

### 3.2. New Database Models (`core/models.py`)

1.  **`Signer`**: A new model to track the individuals in a signature workflow.
    *   `id` (PK)
    *   `contract_id` (FK to `Contract`)
    *   `name` (String)
    *   `email` (String)
    *   `signing_order` (Integer): The order in which the signer must sign (e.g., 1, 2, 3).
    *   `status` (Enum: `created`, `sent`, `delivered`, `signed`, `declined`): The real-time status of the signer.
    *   `docusign_recipient_id` (String): The ID assigned by DocuSign, used for correlation.

2.  **`Contract` Model Update**:
    *   Add a `signature_status` field (Enum: `draft`, `sent`, `completed`, `voided`) to provide a high-level status for the overall signature process.

### 3.3. New API Endpoints

A new router, `api/v1/endpoints/signature.py`, will be created.

*   `POST /contracts/{contract_id}/signature/initiate`:
    *   **Request Body:** Contains a list of signers (name, email, order).
    *   **Logic:** Creates a DocuSign "envelope" with the contract document and signers. Sends the envelope, initiating the signature process.
*   `GET /contracts/{contract_id}/signature/view`:
    *   **Logic:** For the current user, generates a unique, short-lived URL for an embedded signing ceremony via the DocuSign API.
*   `POST /integrations/docusign/webhook`:
    *   **Logic:** A public endpoint to receive real-time status updates from DocuSign Connect. It will parse the incoming XML payload, find the relevant `Contract` and `Signer` by ID, and update their statuses in our database. This is critical for real-time UI updates.

### 3.4. DocuSign Client (`core/docusign_client.py`)

A new service will be created to encapsulate all interactions with the DocuSign eSignature API, handling authentication, token refresh, envelope creation, and view URL generation.

## 4. Frontend Architecture

*   **Signature Configuration Modal:** A new modal will allow users to:
    *   Add, remove, and reorder signers.
    *   Customize the email subject and body for the signature request.
    *   Initiate the signing process by calling the `POST /signature/initiate` endpoint.
*   **Embedded Signing View:** A new page or modal that hosts the DocuSign iFrame, using the URL generated by the `GET /signature/view` endpoint.
*   **Signature Status Tracker:** A new component on the contract detail page will visually display the status of each signer in the workflow (e.g., a timeline showing "Sent to John," "Viewed by Jane," "Awaiting Signature from Bob"). This UI will be updated in real-time via WebSockets connected to our backend, which in turn are updated by the DocuSign webhook.

## 5. Rollout Plan

1.  **Sprint 1 (Backend Auth & Client):** Implement the backend OAuth 2.0 JWT Grant flow for DocuSign. Build the initial `docusign_client.py` service.
2.  **Sprint 2 (Backend Envelope Logic):** Implement the `Signer` model and the API endpoint for creating and sending a DocuSign envelope.
3.  **Sprint 3 (Frontend Configuration):** Build the signature configuration modal in the frontend.
4.  **Sprint 4 (Backend Webhook):** Implement the DocuSign Connect webhook endpoint to handle real-time status updates.
5.  **Sprint 5 (Frontend UI):** Build the real-time signature status tracker component on the contract page.
6.  **Sprint 6 (Embedded Signing):** Implement the embedded signing view. Write comprehensive E2E tests for the entire workflow.